<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blockchain Voting System</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }

    .card h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.5em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: bold;
      color: #555;
    }

    .info-value {
      color: #667eea;
      font-family: "Courier New", monospace;
      word-break: break-all;
      font-size: 0.9em;
    }

    .status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
    }

    .status.connected {
      background: #4caf50;
      color: white;
    }

    .status.disconnected {
      background: #f44336;
      color: white;
    }

    .status.init {
      background: #2196f3;
      color: white;
    }

    .status.commit {
      background: #ff9800;
      color: white;
    }

    .status.reveal {
      background: #9c27b0;
      color: white;
    }

    .status.end {
      background: #f44336;
      color: white;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.3s;
      margin-top: 10px;
      margin-right: 10px;
    }

    button:hover {
      background: #5568d3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .candidate-list {
      list-style: none;
    }

    .candidate-item {
      padding: 15px;
      margin: 10px 0;
      background: #f5f5f5;
      border-left: 4px solid #667eea;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .candidate-name {
      font-weight: bold;
      color: #333;
    }

    .candidate-votes {
      background: #667eea;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: bold;
    }

    .vote-form {
      display: grid;
      gap: 10px;
    }

    input,
    select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
    }

    .log-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-top: 30px;
    }

    .log-container h2 {
      color: #667eea;
      margin-bottom: 15px;
    }

    .event-log {
      max-height: 300px;
      overflow-y: auto;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      font-family: "Courier New", monospace;
      font-size: 0.9em;
    }

    .event-log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
      color: #555;
    }

    .event-log-entry:last-child {
      border-bottom: none;
    }

    .event-log-timestamp {
      color: #999;
      font-weight: bold;
    }

    .event-log-message {
      color: #667eea;
      font-weight: bold;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 15px;
      border: 1px solid #f5c6cb;
    }

    .success {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 15px;
      border: 1px solid #c3e6cb;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #eee;
      border-radius: 5px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s;
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 1.8em;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1>üó≥Ô∏è Blockchain Voting System</h1>
      <p>Secure, transparent, decentralized voting powered by Ethereum</p>
    </header>

    <!-- Connection Status & Details -->
    <div class="grid">
      <!-- Status Card -->
      <div class="card">
        <h2>Status</h2>
        <div class="info-row">
          <span class="info-label">Connection:</span>
          <span id="connectionStatus" class="status disconnected">Disconnected</span>
        </div>
        <div class="info-row">
          <span class="info-label">Account:</span>
          <span id="accountAddress" class="info-value">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Balance:</span>
          <span id="accountBalance" class="info-value">N/A</span>
        </div>
        <button onclick="initializeWeb3()">Connect Web3</button>
      </div>

      <!-- Contract Details -->
      <div class="card">
        <h2>Contract Details</h2>
        <div class="info-row">
          <span class="info-label">Address:</span>
          <span id="contractAddress" class="info-value">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Current Phase:</span>
          <span id="currentPhase" class="status init">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Total Candidates:</span>
          <span id="numCandidates" class="info-value">N/A</span>
        </div>
        <button onclick="refreshContractDetails()">Refresh Details</button>
      </div>

      <!-- Voting Stats -->
      <div class="card">
        <h2>Voting Statistics</h2>
        <div class="info-row">
          <span class="info-label">Whitelisted Voters:</span>
          <span id="whitelistedVoters" class="info-value">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Votes Submitted:</span>
          <span id="votesSubmitted" class="info-value">N/A</span>
        </div>
        <div class="progress-bar">
          <div id="votingProgress" class="progress-fill" style="width: 0%"></div>
        </div>
        <button onclick="refreshStats()">Refresh Stats</button>
      </div>
    </div>

    <!-- Candidates & Results -->
    <div class="grid">
      <!-- Candidates -->
      <div class="card">
        <h2>üìã Candidates</h2>
        <ul id="candidatesList" class="candidate-list">
          <li style="color: #999; padding: 10px 0">Loading candidates...</li>
        </ul>
        <button onclick="loadCandidates()">Load Candidates</button>
      </div>

      <!-- Results -->
      <div class="card">
        <h2>üìä Live Results</h2>
        <ul id="resultsList" class="candidate-list">
          <li style="color: #999; padding: 10px 0">Loading results...</li>
        </ul>
        <button onclick="loadResults()">Refresh Results</button>
      </div>
    </div>

    <!-- Voting Form -->
    <div class="card">
      <h2>üó≥Ô∏è Cast Your Vote</h2>
      <div id="errorMessage" style="display: none" class="error"></div>
      <div id="successMessage" style="display: none" class="success"></div>
      <form id="voteForm" class="vote-form" onsubmit="handleVote(event)">
        <label for="candidateSelect" style="font-weight: bold">Select Candidate:</label>
        <select id="candidateSelect" required>
          <option value="">-- Choose a candidate --</option>
        </select>

        <label for="secretInput" style="font-weight: bold">Secret Passphrase (for commit-reveal):</label>
        <input type="password" id="secretInput" placeholder="Enter a secret phrase" required />

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
          <button type="button" onclick="commitVote()" style="margin: 0">
            Step 1: Commit Vote
          </button>
          <button type="button" onclick="revealVote()" style="margin: 0">
            Step 2: Reveal Vote
          </button>
        </div>

        <small style="color: #999; margin-top: 10px">
          üí° Tip: Commit your vote first, then reveal it after the commit phase ends.
        </small>
      </form>
    </div>

    <!-- Event Log -->
    <div class="log-container">
      <h2>üì° Event Log</h2>
      <div class="event-log" id="eventLog">
        <div class="event-log-entry">
          <span class="event-log-timestamp">[Ready]</span>
          <span class="event-log-message">Waiting for events...</span>
        </div>
      </div>
      <button onclick="clearLog()" style="margin-top: 15px">Clear Log</button>
    </div>
  </div>

  <!-- Web3 Service -->
  <script src="web3-service.js"></script>

  <script>
    // Initialize Web3 service instance
    let web3Service = new Web3Service();
    let committedSecret = null;
    let committedCandidateId = null;

    // Contract ABI (load from deployed contract)
    const VOTING_ABI = [
      "function numCandidates() public view returns (uint)",
      "function currentPhase() public view returns (uint8)",
      "function merkleRoot() public view returns (bytes32)",
      "function candidateNames(uint) public view returns (string)",
      "function votes(uint) public view returns (uint)",
      "function totalVotersWhitelisted() public view returns (uint)",
      "function totalVotesSubmitted() public view returns (uint)",
      "function commitVote(bytes32 commitment) public",
      "function revealVote(uint candidateId, string memory secret) public",
      "event CommitmentMade(address indexed voter, uint timestamp)",
      "event VoteRevealed(address indexed voter, uint indexed candidateId, uint timestamp)",
      "event PhaseChanged(uint8 indexed newPhase, uint timestamp)",
    ];

    const RPC_URL = "http://127.0.0.1:8545";
    const CONTRACT_ADDRESS = localStorage.getItem("votingContractAddress") || "0x0000000000000000000000000000000000000000";

    /**
     * Initialize Web3 connection
     */
    async function initializeWeb3() {
      try {
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> Connecting...';

        if (CONTRACT_ADDRESS === "0x0000000000000000000000000000000000000000") {
          throw new Error("Contract address not found. Please deploy the contract first using 'npm run deploy:localhost'");
        }

        await web3Service.init(RPC_URL, CONTRACT_ADDRESS, VOTING_ABI);
        
        // Update UI
        document.getElementById("connectionStatus").className = "status connected";
        document.getElementById("connectionStatus").textContent = "Connected";

        const account = await web3Service.signer.getAddress();
        document.getElementById("accountAddress").textContent = account;
        
        const balance = await web3Service.getBalance();
        document.getElementById("accountBalance").textContent = balance;

        // Load initial data
        await refreshContractDetails();
        await loadCandidates();
        await loadResults();
        await refreshStats();
        
        // Listen to events
        web3Service.listenToEvents();
        setupEventListeners();

        btn.innerHTML = "Connected ‚úì";
        setTimeout(() => {
          btn.disabled = false;
        }, 2000);

        addLog("Web3 connected successfully");
      } catch (err) {
        showError(err.message);
        event.target.disabled = false;
        event.target.textContent = "Connect Web3";
      }
    }

    /**
     * Refresh contract details
     */
    async function refreshContractDetails() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const details = await web3Service.getContractDetails();
        document.getElementById("contractAddress").textContent = details.address;
        
        const phaseEl = document.getElementById("currentPhase");
        phaseEl.textContent = details.currentPhase;
        phaseEl.className = "status " + details.currentPhase.toLowerCase();

        document.getElementById("numCandidates").textContent = details.numCandidates;
        addLog(`Contract refreshed: Phase = ${details.currentPhase}`);
      } catch (err) {
        showError(err.message);
      }
    }

    /**
     * Load candidates from contract
     */
    async function loadCandidates() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const candidates = await web3Service.getCandidates();
        const select = document.getElementById("candidateSelect");
        const list = document.getElementById("candidatesList");

        // Update select dropdown
        select.innerHTML = '<option value="">-- Choose a candidate --</option>';
        candidates.forEach((c) => {
          select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });

        // Update candidate list
        list.innerHTML = candidates
          .map((c) => `<li class="candidate-item"><span class="candidate-name">${c.name}</span></li>`)
          .join("");

        addLog(`Loaded ${candidates.length} candidates`);
      } catch (err) {
        showError(err.message);
      }
    }

    /**
     * Load voting results
     */
    async function loadResults() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const results = await web3Service.getResults();
        const list = document.getElementById("resultsList");

        list.innerHTML = results
          .map(
            (r) =>
              `<li class="candidate-item"><span class="candidate-name">${r.name}</span><span class="candidate-votes">${r.votes} votes</span></li>`
          )
          .join("");

        addLog(`Results refreshed`);
      } catch (err) {
        showError(err.message);
      }
    }

    /**
     * Refresh voting statistics
     */
    async function refreshStats() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const stats = await web3Service.getStats();
        document.getElementById("whitelistedVoters").textContent = stats.whitelistedVoters;
        document.getElementById("votesSubmitted").textContent = stats.votesSubmitted;

        // Update progress bar
        const progress = stats.whitelistedVoters > 0 ? (stats.votesSubmitted / stats.whitelistedVoters) * 100 : 0;
        document.getElementById("votingProgress").style.width = progress + "%";

        addLog(`Stats: ${stats.votesSubmitted}/${stats.whitelistedVoters} voters participated`);
      } catch (err) {
        showError(err.message);
      }
    }

    /**
     * Commit a vote (step 1)
     */
    async function commitVote() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const candidateId = document.getElementById("candidateSelect").value;
        const secret = document.getElementById("secretInput").value;

        if (!candidateId || !secret) {
          showError("Please select a candidate and enter a secret");
          return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> Committing...';

        const result = await web3Service.commitVote(candidateId, secret);
        
        // Store for reveal step
        committedSecret = secret;
        committedCandidateId = candidateId;
        localStorage.setItem("committedSecret", secret);
        localStorage.setItem("committedCandidateId", candidateId);

        showSuccess(`Vote committed! Secret stored. TX: ${result.txHash.slice(0, 10)}...`);
        addLog(`Vote committed for candidate ${candidateId}`);

        btn.disabled = false;
        btn.textContent = "Step 1: Commit Vote";
      } catch (err) {
        showError(err.message);
        event.target.disabled = false;
        event.target.textContent = "Step 1: Commit Vote";
      }
    }

    /**
     * Reveal a committed vote (step 2)
     */
    async function revealVote() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const secret = committedSecret || localStorage.getItem("committedSecret");
        const candidateId = committedCandidateId || localStorage.getItem("committedCandidateId");

        if (!secret || !candidateId) {
          showError("No committed vote found. Please commit a vote first.");
          return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> Revealing...';

        const txHash = await web3Service.revealVote(candidateId, secret);
        
        // Clear stored values
        committedSecret = null;
        committedCandidateId = null;
        localStorage.removeItem("committedSecret");
        localStorage.removeItem("committedCandidateId");
        document.getElementById("secretInput").value = "";
        document.getElementById("candidateSelect").value = "";

        showSuccess(`Vote revealed! TX: ${txHash.slice(0, 10)}...`);
        addLog(`Vote revealed for candidate ${candidateId}`);
        
        // Refresh results
        await loadResults();

        btn.disabled = false;
        btn.textContent = "Step 2: Reveal Vote";
      } catch (err) {
        showError(err.message);
        event.target.disabled = false;
        event.target.textContent = "Step 2: Reveal Vote";
      }
    }

    /**
     * Setup event listeners from contract
     */
    function setupEventListeners() {
      window.addEventListener("voteCommitted", (event) => {
        addLog(`üìù Vote committed by ${event.detail.voter.slice(0, 10)}...`);
      });

      window.addEventListener("voteRevealed", (event) => {
        addLog(`‚úì Vote revealed for candidate ${event.detail.candidateId}`);
        loadResults();
      });

      window.addEventListener("phaseChanged", (event) => {
        addLog(`üîÑ Phase changed to: ${event.detail.newPhase}`);
        refreshContractDetails();
      });
    }

    /**
     * Add entry to event log
     */
    function addLog(message) {
      const log = document.getElementById("eventLog");
      const entry = document.createElement("div");
      entry.className = "event-log-entry";
      const now = new Date().toLocaleTimeString();
      entry.innerHTML = `<span class="event-log-timestamp">[${now}]</span> <span class="event-log-message">${message}</span>`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    /**
     * Clear event log
     */
    function clearLog() {
      document.getElementById("eventLog").innerHTML = '<div class="event-log-entry"><span class="event-log-timestamp">[Cleared]</span><span class="event-log-message">Log cleared</span></div>';
    }

    /**
     * Show error message
     */
    function showError(message) {
      const el = document.getElementById("errorMessage");
      el.textContent = "‚ùå " + message;
      el.style.display = "block";
      document.getElementById("successMessage").style.display = "none";
      setTimeout(() => {
        el.style.display = "none";
      }, 5000);
    }

    /**
     * Show success message
     */
    function showSuccess(message) {
      const el = document.getElementById("successMessage");
      el.textContent = "‚úì " + message;
      el.style.display = "block";
      document.getElementById("errorMessage").style.display = "none";
      setTimeout(() => {
        el.style.display = "none";
      }, 5000);
    }

    /**
     * On page load - try to load contract address from localStorage or deployments
     */
    window.addEventListener("load", async () => {
      // Try to fetch contract address from deployment file
      try {
        const response = await fetch("/deployments/deployment-hardhat-latest.json");
        if (response.ok) {
          const deployment = await response.json();
          localStorage.setItem("votingContractAddress", deployment.votingAddress);
          location.reload();
        }
      } catch (err) {
        console.log("Deployment file not found. Please deploy the contract first.");
      }
    });
  </script>
</body>
</html>
