<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blockchain Voting System</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: #e2e8f0;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 50px;
      animation: fadeInDown 0.8s ease-out;
    }

    header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 3.5em;
      font-weight: 700;
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 15px;
      letter-spacing: -2px;
    }

    header p {
      font-size: 1.1em;
      color: #cbd5e1;
      font-weight: 300;
      letter-spacing: 0.5px;
    }

    .wallet-section {
      text-align: center;
      margin-bottom: 40px;
    }

    .wallet-button {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 50px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      border: 2px solid transparent;
    }

    .wallet-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5);
    }

    .wallet-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .wallet-info {
      margin-top: 15px;
      font-size: 0.95em;
      color: #94a3b8;
    }

    .wallet-address {
      font-family: 'Courier New', monospace;
      color: #60a5fa;
      word-break: break-all;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .card {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(100, 116, 139, 0.2);
      border-radius: 16px;
      padding: 32px;
      backdrop-filter: blur(10px);
      transition: all 0.4s ease;
      animation: fadeInUp 0.6s ease-out;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .card:hover {
      transform: translateY(-8px);
      border-color: rgba(100, 116, 139, 0.4);
      box-shadow: 0 20px 60px rgba(59, 130, 246, 0.15);
    }

    .card h2 {
      font-family: 'Playfair Display', serif;
      color: #f0f9ff;
      margin-bottom: 24px;
      font-size: 1.6em;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 2px solid rgba(100, 116, 139, 0.2);
      padding-bottom: 15px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid rgba(100, 116, 139, 0.1);
      transition: background-color 0.3s ease;
    }

    .info-row:hover {
      background-color: rgba(59, 130, 246, 0.05);
      padding-left: 8px;
      margin-left: -8px;
      padding-right: 8px;
      margin-right: -8px;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #cbd5e1;
      font-size: 0.95em;
    }

    .info-value {
      color: #60a5fa;
      font-family: 'Courier New', monospace;
      word-break: break-all;
      font-size: 0.9em;
      text-align: right;
      flex: 1;
      margin-left: 15px;
    }

    .status {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 0.85em;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .status.connected {
      background: rgba(34, 197, 94, 0.15);
      color: #86efac;
      border: 1px solid #22c55e;
    }

    .status.disconnected {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      border: 1px solid #ef4444;
    }

    .status.init {
      background: rgba(59, 130, 246, 0.15);
      color: #93c5fd;
      border: 1px solid #3b82f6;
    }

    .status.commit {
      background: rgba(251, 146, 60, 0.15);
      color: #fed7aa;
      border: 1px solid #fb923c;
    }

    .status.reveal {
      background: rgba(168, 85, 247, 0.15);
      color: #e9d5ff;
      border: 1px solid #a855f7;
    }

    .status.end {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      border: 1px solid #ef4444;
    }

    .btn {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.95em;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-top: 12px;
      margin-right: 10px;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      border-color: rgba(59, 130, 246, 0.6);
    }

    .btn:disabled {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .btn.secondary {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      box-shadow: 0 4px 15px rgba(71, 85, 105, 0.2);
      border-color: rgba(71, 85, 105, 0.3);
    }

    .btn.secondary:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(71, 85, 105, 0.4);
    }

    .btn.success {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
      border-color: rgba(34, 197, 94, 0.3);
    }

    .btn.success:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }

    .candidate-list {
      list-style: none;
    }

    .candidate-item {
      padding: 16px;
      margin: 12px 0;
      background: rgba(30, 41, 59, 0.8);
      border-left: 4px solid #3b82f6;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(100, 116, 139, 0.1);
    }

    .candidate-item:hover {
      background: rgba(30, 41, 59, 1);
      border-left-color: #60a5fa;
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    .candidate-name {
      font-weight: 600;
      color: #f0f9ff;
      flex: 1;
    }

    .candidate-votes {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9em;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .vote-form {
      display: grid;
      gap: 15px;
    }

    label {
      font-weight: 600;
      color: #cbd5e1;
      font-size: 0.95em;
      margin-bottom: 5px;
      display: block;
    }

    input,
    select {
      padding: 12px 16px;
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 10px;
      font-size: 1em;
      background: rgba(15, 23, 42, 0.5);
      color: #e2e8f0;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    input::placeholder,
    select {
      color: #94a3b8;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: rgba(15, 23, 42, 0.8);
    }

    .log-container {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(100, 116, 139, 0.2);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      margin-top: 40px;
      animation: fadeInUp 0.6s ease-out 0.2s both;
    }

    .log-container h2 {
      font-family: 'Playfair Display', serif;
      color: #f0f9ff;
      margin-bottom: 24px;
      font-size: 1.6em;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 2px solid rgba(100, 116, 139, 0.2);
      padding-bottom: 15px;
    }

    .event-log {
      max-height: 350px;
      overflow-y: auto;
      background: rgba(15, 23, 42, 0.5);
      padding: 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      border: 1px solid rgba(100, 116, 139, 0.1);
    }

    .event-log::-webkit-scrollbar {
      width: 6px;
    }

    .event-log::-webkit-scrollbar-track {
      background: transparent;
    }

    .event-log::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.3);
      border-radius: 3px;
    }

    .event-log::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.5);
    }

    .event-log-entry {
      padding: 8px 0;
      border-bottom: 1px solid rgba(100, 116, 139, 0.1);
      color: #cbd5e1;
      animation: slideInLeft 0.3s ease-out;
    }

    .event-log-entry:last-child {
      border-bottom: none;
    }

    .event-log-timestamp {
      color: #64748b;
      font-weight: 600;
      margin-right: 10px;
    }

    .event-log-message {
      color: #60a5fa;
      font-weight: 600;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .alert {
      padding: 16px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 500;
      border-left: 4px solid;
      animation: slideInDown 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert.error {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
      border-left-color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .alert.success {
      background: rgba(34, 197, 94, 0.1);
      color: #86efac;
      border-left-color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(100, 116, 139, 0.2);
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
      border: 1px solid rgba(100, 116, 139, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      width: 0%;
      transition: width 0.5s ease;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    }

    .vote-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 15px;
    }

    .vote-buttons .btn {
      margin: 0;
    }

    .tip {
      color: #94a3b8;
      font-size: 0.9em;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 2.2em;
      }

      header p {
        font-size: 1em;
      }

      .grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .card, .log-container {
        padding: 24px;
      }

      .vote-buttons {
        grid-template-columns: 1fr;
      }

      .info-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .info-value {
        text-align: left;
        margin-left: 0;
        margin-top: 8px;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üó≥Ô∏è Blockchain Voting</h1>
      <p>Secure, transparent, decentralized voting on Ethereum</p>
    </header>

    <div class="wallet-section">
      <button class="wallet-button" id="connectWalletBtn" onclick="connectWallet()">
        <span>ü¶ä</span>
        <span id="walletBtnText">Connect MetaMask</span>
      </button>
      <div class="wallet-info" id="walletInfo" style="display: none">
        Connected: <span class="wallet-address" id="walletAddress"></span>
      </div>
    </div>

    <div id="errorMessage" class="alert alert-error" style="display: none"></div>
    <div id="successMessage" class="alert alert-success" style="display: none"></div>

    <div class="grid">
      <div class="card">
        <h2>‚õìÔ∏è Status</h2>
        <div class="info-row">
          <span class="info-label">Connection:</span>
          <span id="connectionStatus" class="status disconnected">Disconnected</span>
        </div>
        <div class="info-row">
          <span class="info-label">Account:</span>
          <span id="accountAddress" class="info-value">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Balance:</span>
          <span id="accountBalance" class="info-value">N/A</span>
        </div>
        <button class="btn" onclick="initializeWeb3()">Initialize Contract</button>
      </div>

      <div class="card">
        <h2>üìã Contract</h2>
        <div class="info-row">
          <span class="info-label">Address:</span>
          <span id="contractAddress" class="info-value">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Phase:</span>
          <span id="currentPhase" class="status init">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Candidates:</span>
          <span id="numCandidates" class="info-value">N/A</span>
        </div>
        <button class="btn secondary" onclick="refreshContractDetails()">Refresh</button>
      </div>

      <div class="card">
        <h2>üìä Statistics</h2>
        <div class="info-row">
          <span class="info-label">Whitelisted Voters:</span>
          <span id="whitelistedVoters" class="info-value">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Votes Submitted:</span>
          <span id="votesSubmitted" class="info-value">N/A</span>
        </div>
        <div class="progress-bar">
          <div id="votingProgress" class="progress-fill"></div>
        </div>
        <button class="btn secondary" onclick="refreshStats()">Refresh</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üë• Candidates</h2>
        <ul id="candidatesList" class="candidate-list">
          <li style="color: #94a3b8; padding: 10px 0">Loading candidates...</li>
        </ul>
        <button class="btn secondary" onclick="loadCandidates()">Load Candidates</button>
      </div>

      <div class="card">
        <h2>üèÜ Live Results</h2>
        <ul id="resultsList" class="candidate-list">
          <li style="color: #94a3b8; padding: 10px 0">Loading results...</li>
        </ul>
        <button class="btn secondary" onclick="loadResults()">Refresh Results</button>
      </div>
    </div>

    <div class="card">
      <h2>üó≥Ô∏è Cast Your Vote</h2>
      <form id="voteForm" class="vote-form" onsubmit="handleVote(event)">
        <div>
          <label for="candidateSelect">Select Candidate:</label>
          <select id="candidateSelect" required>
            <option value="">-- Choose a candidate --</option>
          </select>
        </div>

        <div>
          <label for="secretInput">Secret Passphrase (commit-reveal):</label>
          <input type="password" id="secretInput" placeholder="Enter a secret phrase to protect your vote" required />
        </div>

        <div class="vote-buttons">
          <button type="button" class="btn success" onclick="commitVote()">
            Step 1: Commit
          </button>
          <button type="button" class="btn success" onclick="revealVote()">
            Step 2: Reveal
          </button>
        </div>

        <p class="tip">üí° Commit your vote first, then reveal it after the commit phase ends.</p>
      </form>
    </div>

    <div class="log-container">
      <h2>üì° Event Log</h2>
      <div class="event-log" id="eventLog">
        <div class="event-log-entry">
          <span class="event-log-timestamp">[Ready]</span>
          <span class="event-log-message">Waiting for events...</span>
        </div>
      </div>
      <button class="btn secondary" onclick="clearLog()" style="margin-top: 20px">Clear Log</button>
    </div>
  </div>

  <script src="web3-service.js"></script>

  <script>
    let web3Service = new Web3Service();
    let committedSecret = null;
    let committedCandidateId = null;

    const VOTING_ABI = [
      "function numCandidates() public view returns (uint)",
      "function currentPhase() public view returns (uint8)",
      "function merkleRoot() public view returns (bytes32)",
      "function candidateNames(uint) public view returns (string)",
      "function votes(uint) public view returns (uint)",
      "function totalVotersWhitelisted() public view returns (uint)",
      "function totalVotesSubmitted() public view returns (uint)",
      "function commitVote(bytes32 commitment) public",
      "function revealVote(uint candidateId, string memory secret) public",
      "event CommitmentMade(address indexed voter, uint timestamp)",
      "event VoteRevealed(address indexed voter, uint indexed candidateId, uint timestamp)",
      "event PhaseChanged(uint8 indexed newPhase, uint timestamp)",
    ];

    const RPC_URL = "http://127.0.0.1:8545";
    const CONTRACT_ADDRESS = localStorage.getItem("votingContractAddress") || "0x0000000000000000000000000000000000000000";

    async function connectWallet() {
      try {
        const btn = document.getElementById('connectWalletBtn');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> <span>Connecting...</span>';

        if (!Web3Service.isMetaMaskInstalled()) {
          throw new Error('MetaMask is not installed. Please install it to continue.');
        }

        const address = await web3Service.connectMetaMask();
        
        document.getElementById('walletAddress').textContent = address;
        document.getElementById('walletInfo').style.display = 'block';
        document.getElementById('accountAddress').textContent = address;
        
        const balance = await web3Service.getBalance();
        document.getElementById('accountBalance').textContent = balance;

        btn.innerHTML = '‚úì Connected';
        setTimeout(() => {
          btn.innerHTML = '<span>ü¶ä</span> <span>Wallet Connected</span>';
          btn.disabled = false;
        }, 2000);

        showSuccess('Wallet connected successfully!');
        addLog('‚úì MetaMask wallet connected');
      } catch (err) {
        showError(err.message);
        const btn = document.getElementById('connectWalletBtn');
        btn.innerHTML = '<span>ü¶ä</span> <span>Connect MetaMask</span>';
        btn.disabled = false;
      }
    }

    async function initializeWeb3() {
      try {
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> Initializing...';

        if (CONTRACT_ADDRESS === "0x0000000000000000000000000000000000000000") {
          throw new Error('Contract address not found. Please deploy the contract first.');
        }

        await web3Service.init(RPC_URL, CONTRACT_ADDRESS, VOTING_ABI);
        
        document.getElementById("connectionStatus").className = "status connected";
        document.getElementById("connectionStatus").textContent = "Connected";

        await refreshContractDetails();
        await loadCandidates();
        await loadResults();
        await refreshStats();
        
        web3Service.listenToEvents();
        setupEventListeners();

        btn.textContent = "‚úì Initialized";
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = "Initialize Contract";
        }, 2000);

        addLog("Contract initialized successfully");
      } catch (err) {
        showError(err.message);
        event.target.disabled = false;
        event.target.textContent = "Initialize Contract";
      }
    }

    async function refreshContractDetails() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const details = await web3Service.getContractDetails();
        document.getElementById("contractAddress").textContent = details.address.slice(0, 10) + '...';
        
        const phaseEl = document.getElementById("currentPhase");
        phaseEl.textContent = details.currentPhase;
        phaseEl.className = "status " + details.currentPhase.toLowerCase();

        document.getElementById("numCandidates").textContent = details.numCandidates;
        addLog(`Contract refreshed: Phase = ${details.currentPhase}`);
      } catch (err) {
        showError(err.message);
      }
    }

    async function loadCandidates() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const candidates = await web3Service.getCandidates();
        const select = document.getElementById("candidateSelect");
        const list = document.getElementById("candidatesList");

        select.innerHTML = '<option value="">-- Choose a candidate --</option>';
        candidates.forEach((c) => {
          select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });

        list.innerHTML = candidates
          .map((c) => `<li class="candidate-item"><span class="candidate-name">${c.name}</span></li>`)
          .join("");

        addLog(`Loaded ${candidates.length} candidates`);
      } catch (err) {
        showError(err.message);
      }
    }

    async function loadResults() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const results = await web3Service.getResults();
        const list = document.getElementById("resultsList");

        list.innerHTML = results
          .map(
            (r) =>
              `<li class="candidate-item"><span class="candidate-name">${r.name}</span><span class="candidate-votes">${r.votes} votes</span></li>`
          )
          .join("");

        addLog(`Results refreshed`);
      } catch (err) {
        showError(err.message);
      }
    }

    async function refreshStats() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const stats = await web3Service.getStats();
        document.getElementById("whitelistedVoters").textContent = stats.whitelistedVoters;
        document.getElementById("votesSubmitted").textContent = stats.votesSubmitted;

        const progress = stats.whitelistedVoters > 0 ? (stats.votesSubmitted / stats.whitelistedVoters) * 100 : 0;
        document.getElementById("votingProgress").style.width = progress + "%";

        addLog(`Stats: ${stats.votesSubmitted}/${stats.whitelistedVoters} voters participated`);
      } catch (err) {
        showError(err.message);
      }
    }

    async function commitVote() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const candidateId = document.getElementById("candidateSelect").value;
        const secret = document.getElementById("secretInput").value;

        if (!candidateId || !secret) {
          showError("Please select a candidate and enter a secret");
          return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> Committing...';

        const result = await web3Service.commitVote(candidateId, secret);
        
        committedSecret = secret;
        committedCandidateId = candidateId;
        localStorage.setItem("committedSecret", secret);
        localStorage.setItem("committedCandidateId", candidateId);

        showSuccess(`Vote committed! TX: ${result.txHash.slice(0, 10)}...`);
        addLog(`Vote committed for candidate ${candidateId}`);

        btn.disabled = false;
        btn.textContent = "Step 1: Commit";
      } catch (err) {
        showError(err.message);
        event.target.disabled = false;
        event.target.textContent = "Step 1: Commit";
      }
    }

    async function revealVote() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const secret = committedSecret || localStorage.getItem("committedSecret");
        const candidateId = committedCandidateId || localStorage.getItem("committedCandidateId");

        if (!secret || !candidateId) {
          showError("No committed vote found. Please commit a vote first.");
          return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> Revealing...';

        const txHash = await web3Service.revealVote(candidateId, secret);
        
        committedSecret = null;
        committedCandidateId = null;
        localStorage.removeItem("committedSecret");
        localStorage.removeItem("committedCandidateId");
        document.getElementById("secretInput").value = "";
        document.getElementById("candidateSelect").value = "";

        showSuccess(`Vote revealed! TX: ${txHash.slice(0, 10)}...`);
        addLog(`Vote revealed for candidate ${candidateId}`);
        
        await loadResults();

        btn.disabled = false;
        btn.textContent = "Step 2: Reveal";
      } catch (err) {
        showError(err.message);
        event.target.disabled = false;
        event.target.textContent = "Step 2: Reveal";
      }
    }

    function setupEventListeners() {
      window.addEventListener("voteCommitted", (event) => {
        addLog(`üìù Vote committed by ${event.detail.voter.slice(0, 10)}...`);
      });

      window.addEventListener("voteRevealed", (event) => {
        addLog(`‚úì Vote revealed for candidate ${event.detail.candidateId}`);
        loadResults();
      });

      window.addEventListener("phaseChanged", (event) => {
        addLog(`üîÑ Phase changed to: ${event.detail.newPhase}`);
        refreshContractDetails();
      });
    }

    function addLog(message) {
      const log = document.getElementById("eventLog");
      const entry = document.createElement("div");
      entry.className = "event-log-entry";
      const now = new Date().toLocaleTimeString();
      entry.innerHTML = `<span class="event-log-timestamp">[${now}]</span> <span class="event-log-message">${message}</span>`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    function clearLog() {
      document.getElementById("eventLog").innerHTML = '<div class="event-log-entry"><span class="event-log-timestamp">[Cleared]</span><span class="event-log-message">Log cleared</span></div>';
    }

    function showError(message) {
      const el = document.getElementById("errorMessage");
      el.innerHTML = '<span>‚ùå</span> <span>' + message + '</span>';
      el.style.display = "flex";
      document.getElementById("successMessage").style.display = "none";
      setTimeout(() => {
        el.style.display = "none";
      }, 6000);
    }

    function showSuccess(message) {
      const el = document.getElementById("successMessage");
      el.innerHTML = '<span>‚úì</span> <span>' + message + '</span>';
      el.style.display = "flex";
      document.getElementById("errorMessage").style.display = "none";
      setTimeout(() => {
        el.style.display = "none";
      }, 6000);
    }

    window.addEventListener("load", async () => {
      try {
        const response = await fetch("/deployments/deployment-hardhat-latest.json");
        if (response.ok) {
          const deployment = await response.json();
          localStorage.setItem("votingContractAddress", deployment.votingAddress);
          location.reload();
        }
      } catch (err) {
        console.log("Deployment file not found. Deploy the contract first.");
      }

      // Setup MetaMask listeners if available
      if (Web3Service.isMetaMaskInstalled()) {
        web3Service.onAccountChange((address) => {
          document.getElementById('walletAddress').textContent = address;
          document.getElementById('accountAddress').textContent = address;
          addLog(`Account changed to: ${address.slice(0, 10)}...`);
        });

        web3Service.onNetworkChange((chainId) => {
          addLog(`Network changed to chain ID: ${chainId}`);
        });
      }
    });
  </script>
</body>
</html>
