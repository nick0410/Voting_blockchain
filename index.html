<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No_vote_chori</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #ffffff 0%, #fffbf5 50%, #ffffff 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: #333333;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 50%, rgba(255, 153, 51, 0.08) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(255, 153, 51, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 50px;
      animation: fadeInDown 0.8s ease-out;
    }

    header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 3.5em;
      font-weight: 700;
      color: #FF9933;
      margin-bottom: 15px;
      letter-spacing: -2px;
      text-shadow: 2px 2px 4px rgba(255, 153, 51, 0.1);
    }

    header p {
      font-size: 1.1em;
      color: #666666;
      font-weight: 300;
      letter-spacing: 0.5px;
    }

    .wallet-section {
      text-align: center;
      margin-bottom: 40px;
    }

    .wallet-button {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, #FF9933 0%, #FF8C00 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 50px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3);
      border: 2px solid transparent;
    }

    .wallet-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 153, 51, 0.5);
      background: linear-gradient(135deg, #FF8C00 0%, #FF7700 100%);
    }

    .wallet-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .wallet-info {
      margin-top: 15px;
      font-size: 0.95em;
      color: #999999;
    }

    .wallet-address {
      font-family: 'Courier New', monospace;
      color: #FF9933;
      word-break: break-all;
      font-weight: 600;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .card {
      background: linear-gradient(135deg, #ffffff 0%, #fffaf5 100%);
      border: 2px solid #FF9933;
      border-radius: 16px;
      padding: 32px;
      backdrop-filter: blur(10px);
      transition: all 0.4s ease;
      animation: fadeInUp 0.6s ease-out;
      box-shadow: 0 10px 30px rgba(255, 153, 51, 0.1);
    }

    .card:hover {
      transform: translateY(-8px);
      border-color: #FF8C00;
      box-shadow: 0 20px 50px rgba(255, 153, 51, 0.25);
    }

    .card h2 {
      font-family: 'Playfair Display', serif;
      color: #FF9933;
      margin-bottom: 24px;
      font-size: 1.6em;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 3px solid #FF9933;
      padding-bottom: 15px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid rgba(255, 153, 51, 0.15);
      transition: background-color 0.3s ease;
    }

    .info-row:hover {
      background-color: rgba(255, 153, 51, 0.05);
      padding-left: 8px;
      margin-left: -8px;
      padding-right: 8px;
      margin-right: -8px;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #555555;
      font-size: 0.95em;
    }

    .info-value {
      color: #FF9933;
      font-family: 'Courier New', monospace;
      word-break: break-all;
      font-size: 0.9em;
      text-align: right;
      flex: 1;
      margin-left: 15px;
      font-weight: 600;
    }

    .status {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 0.85em;
      font-weight: 600;
      letter-spacing: 0.5px;
      border: 2px solid;
    }

    .status.connected {
      background: rgba(255, 153, 51, 0.15);
      color: #FF9933;
      border-color: #FF9933;
    }

    .status.disconnected {
      background: rgba(200, 200, 200, 0.15);
      color: #999999;
      border-color: #999999;
    }

    .status.init {
      background: rgba(255, 153, 51, 0.15);
      color: #FF9933;
      border-color: #FF9933;
    }

    .status.commit {
      background: rgba(255, 153, 51, 0.2);
      color: #FF8C00;
      border-color: #FF8C00;
    }

    .status.reveal {
      background: rgba(255, 153, 51, 0.25);
      color: #FF7700;
      border-color: #FF7700;
    }

    .status.end {
      background: rgba(200, 200, 200, 0.15);
      color: #999999;
      border-color: #999999;
    }

    .btn {
      background: linear-gradient(135deg, #FF9933 0%, #FF8C00 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.95em;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-top: 12px;
      margin-right: 10px;
      box-shadow: 0 4px 15px rgba(255, 153, 51, 0.2);
      border: 2px solid rgba(255, 153, 51, 0.3);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 153, 51, 0.4);
      border-color: rgba(255, 153, 51, 0.8);
      background: linear-gradient(135deg, #FF8C00 0%, #FF7700 100%);
    }

    .btn:disabled {
      background: linear-gradient(135deg, #cccccc 0%, #aaaaaa 100%);
      cursor: not-allowed;
      opacity: 0.6;
      border-color: #999999;
    }

    .btn.secondary {
      background: linear-gradient(135deg, #f5f5f5 0%, #eeeeee 100%);
      color: #333333;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border-color: rgba(255, 153, 51, 0.2);
    }

    .btn.secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, #eeeeee 0%, #dddddd 100%);
      box-shadow: 0 6px 20px rgba(255, 153, 51, 0.2);
      border-color: rgba(255, 153, 51, 0.5);
    }

    .btn.success {
      background: linear-gradient(135deg, #FF9933 0%, #FF8C00 100%);
      box-shadow: 0 4px 15px rgba(255, 153, 51, 0.2);
      border-color: rgba(255, 153, 51, 0.3);
    }

    .btn.success:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(255, 153, 51, 0.4);
      background: linear-gradient(135deg, #FF8C00 0%, #FF7700 100%);
    }

    .candidate-list {
      list-style: none;
    }

    .candidate-item {
      padding: 16px;
      margin: 12px 0;
      background: rgba(255, 153, 51, 0.08);
      border-left: 4px solid #FF9933;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 153, 51, 0.2);
    }

    .candidate-item:hover {
      background: rgba(255, 153, 51, 0.12);
      border-left-color: #FF8C00;
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(255, 153, 51, 0.15);
    }

    .candidate-name {
      font-weight: 600;
      color: #333333;
      flex: 1;
    }

    .candidate-votes {
      background: linear-gradient(135deg, #FF9933 0%, #FF8C00 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9em;
      box-shadow: 0 4px 12px rgba(255, 153, 51, 0.3);
    }

    .vote-form {
      display: grid;
      gap: 15px;
    }

    label {
      font-weight: 600;
      color: #555555;
      font-size: 0.95em;
      margin-bottom: 5px;
      display: block;
    }

    input,
    select {
      padding: 12px 16px;
      border: 2px solid #FF9933;
      border-radius: 10px;
      font-size: 1em;
      background: #ffffff;
      color: #333333;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    input::placeholder,
    select {
      color: #999999;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #FF8C00;
      box-shadow: 0 0 0 3px rgba(255, 153, 51, 0.15);
      background: #fffbf5;
    }

    .log-container {
      background: linear-gradient(135deg, #ffffff 0%, #fffaf5 100%);
      border: 2px solid #FF9933;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 10px 30px rgba(255, 153, 51, 0.1);
      backdrop-filter: blur(10px);
      margin-top: 40px;
      animation: fadeInUp 0.6s ease-out 0.2s both;
    }

    .log-container h2 {
      font-family: 'Playfair Display', serif;
      color: #FF9933;
      margin-bottom: 24px;
      font-size: 1.6em;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 3px solid #FF9933;
      padding-bottom: 15px;
    }

    .event-log {
      max-height: 350px;
      overflow-y: auto;
      background: rgba(255, 153, 51, 0.05);
      padding: 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      border: 1px solid rgba(255, 153, 51, 0.15);
      color: #333333;
    }

    .event-log::-webkit-scrollbar {
      width: 6px;
    }

    .event-log::-webkit-scrollbar-track {
      background: transparent;
    }

    .event-log::-webkit-scrollbar-thumb {
      background: rgba(255, 153, 51, 0.3);
      border-radius: 3px;
    }

    .event-log::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 153, 51, 0.5);
    }

    .event-log-entry {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 153, 51, 0.1);
      color: #555555;
      animation: slideInLeft 0.3s ease-out;
    }

    .event-log-entry:last-child {
      border-bottom: none;
    }

    .event-log-timestamp {
      color: #999999;
      font-weight: 600;
      margin-right: 10px;
    }

    .event-log-message {
      color: #FF9933;
      font-weight: 600;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 153, 51, 0.3);
      border-top-color: #FF9933;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .alert {
      padding: 16px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 500;
      border-left: 4px solid;
      animation: slideInDown 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert.alert-error {
      background: rgba(200, 100, 100, 0.1);
      color: #cc6666;
      border-left-color: #cc6666;
      border: 1px solid rgba(200, 100, 100, 0.2);
    }

    .alert.alert-success {
      background: rgba(255, 153, 51, 0.15);
      color: #FF9933;
      border-left-color: #FF9933;
      border: 1px solid rgba(255, 153, 51, 0.2);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 153, 51, 0.15);
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
      border: 1px solid rgba(255, 153, 51, 0.2);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #FF9933, #FF8C00);
      width: 0%;
      transition: width 0.5s ease;
      box-shadow: 0 0 10px rgba(255, 153, 51, 0.3);
    }

    .vote-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 15px;
    }

    .vote-buttons .btn {
      margin: 0;
    }

    .tip {
      color: #999999;
      font-size: 0.9em;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .registration-section {
      display: flex;
      justify-content: center;
      margin-bottom: 40px;
    }

    .registration-card {
      max-width: 500px;
      width: 100%;
      animation: fadeInUp 0.6s ease-out;
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 2.2em;
      }

      header p {
        font-size: 1em;
      }

      .grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .card, .log-container {
        padding: 24px;
      }

      .vote-buttons {
        grid-template-columns: 1fr;
      }

      .info-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .info-value {
        text-align: left;
        margin-left: 0;
        margin-top: 8px;
        width: 100%;
      }

      .registration-card {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üó≥Ô∏è No_vote_chori</h1>
      <p>Secure, transparent, decentralized voting on Ethereum</p>
    </header>

    <div id="registrationSection" class="registration-section">
      <div class="card registration-card">
        <h2>üìù User Registration</h2>
        <div class="alert alert-success" style="margin-bottom: 20px; display: flex;">
          <span>‚úì</span>
          <span><strong>Demo Mode:</strong> Default users (Alice, Bob, Charlie) are pre-registered. You can register as a new user or proceed to voting.</span>
        </div>
        <form id="registrationForm" class="vote-form" onsubmit="handleRegistration(event)">
          <div>
            <label for="regEmail">Email Address:</label>
            <input type="email" id="regEmail" placeholder="your@email.com" required />
          </div>

          <div>
            <label for="regPassword">Password:</label>
            <input type="password" id="regPassword" placeholder="Enter a strong password" required />
          </div>

          <div>
            <label for="regConfirm">Confirm Password:</label>
            <input type="password" id="regConfirm" placeholder="Confirm your password" required />
          </div>

          <div>
            <label for="regFullName">Full Name:</label>
            <input type="text" id="regFullName" placeholder="Your full name" required />
          </div>

          <button type="submit" class="btn success">Register Account</button>
        </form>
      </div>
    </div>

    <div id="votingSection" style="display: none">
      <div class="wallet-section">
        <button class="wallet-button" id="connectWalletBtn" onclick="connectWallet()">
          <span>ü¶ä</span>
          <span id="walletBtnText">Connect MetaMask</span>
        </button>
        <div class="wallet-info" id="walletInfo" style="display: none">
          Connected: <span class="wallet-address" id="walletAddress"></span>
        </div>
      </div>
    </div>

    <div id="errorMessage" class="alert alert-error" style="display: none"></div>
    <div id="successMessage" class="alert alert-success" style="display: none"></div>

    <div class="grid">
      <div class="card">
        <h2>‚õìÔ∏è Status</h2>
        <div class="info-row">
          <span class="info-label">Connection:</span>
          <span id="connectionStatus" class="status disconnected">Disconnected</span>
        </div>
        <div class="info-row">
          <span class="info-label">Account:</span>
          <span id="accountAddress" class="info-value">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Balance:</span>
          <span id="accountBalance" class="info-value">N/A</span>
        </div>
        <button class="btn" id="initContractBtn" onclick="initializeWeb3()">Initialize Contract</button>
      </div>

      <div class="card">
        <h2>üìã Contract</h2>
        <div class="info-row">
          <span class="info-label">Address:</span>
          <span id="contractAddress" class="info-value">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Phase:</span>
          <span id="currentPhase" class="status init">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Candidates:</span>
          <span id="numCandidates" class="info-value">N/A</span>
        </div>
        <button class="btn secondary" onclick="refreshContractDetails()">Refresh</button>
      </div>

      <div class="card">
        <h2>üìä Statistics</h2>
        <div class="info-row">
          <span class="info-label">Whitelisted Voters:</span>
          <span id="whitelistedVoters" class="info-value">N/A</span>
        </div>
        <div class="info-row">
          <span class="info-label">Votes Submitted:</span>
          <span id="votesSubmitted" class="info-value">N/A</span>
        </div>
        <div class="progress-bar">
          <div id="votingProgress" class="progress-fill"></div>
        </div>
        <button class="btn secondary" onclick="refreshStats()">Refresh</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üë• Candidates</h2>
        <ul id="candidatesList" class="candidate-list">
          <li style="color: #999999; padding: 10px 0">Loading candidates...</li>
        </ul>
        <button class="btn secondary" onclick="loadCandidates()">Load Candidates</button>
      </div>

      <div class="card">
        <h2>üèÜ Live Results</h2>
        <ul id="resultsList" class="candidate-list">
          <li style="color: #999999; padding: 10px 0">Loading results...</li>
        </ul>
        <button class="btn secondary" onclick="loadResults()">Refresh Results</button>
      </div>

      <div class="card">
        <h2>üë• Registered Voters</h2>
        <ul id="votersList" class="candidate-list">
          <li style="color: #999999; padding: 10px 0">No registered voters yet</li>
        </ul>
        <button class="btn secondary" onclick="loadVoters()">Refresh Voters</button>
      </div>
    </div>

    <div class="card">
      <h2>üó≥Ô∏è Cast Your Vote</h2>
      <form id="voteForm" class="vote-form" onsubmit="handleVote(event)">
        <div>
          <label for="candidateSelect">Select Candidate:</label>
          <select id="candidateSelect" required>
            <option value="">-- Choose a candidate --</option>
          </select>
        </div>

        <div>
          <label for="secretInput">Secret Passphrase (commit-reveal):</label>
          <input type="password" id="secretInput" placeholder="Enter a secret phrase to protect your vote" required />
        </div>

        <div class="vote-buttons">
          <button type="button" class="btn success" onclick="commitVote()">
            Step 1: Commit
          </button>
          <button type="button" class="btn success" onclick="revealVote()">
            Step 2: Reveal
          </button>
        </div>

        <p class="tip">üí° Commit your vote first, then reveal it after the commit phase ends.</p>
      </form>
    </div>

    <div class="log-container">
      <h2>üì° Event Log</h2>
      <div class="event-log" id="eventLog">
        <div class="event-log-entry">
          <span class="event-log-timestamp">[Ready]</span>
          <span class="event-log-message">Waiting for events...</span>
        </div>
      </div>
      <button class="btn secondary" onclick="clearLog()" style="margin-top: 20px">Clear Log</button>
    </div>
  </div>

  <script src="web3-service.js"></script>

  <script>
    let web3Service = new Web3Service();
    let committedSecret = null;
    let committedCandidateId = null;
    let deploymentData = null;
    let userRegistered = false;

    const VOTING_ABI = [
      "function getTotalCandidates() public view returns (uint)",
      "function getCurrentPhase() public view returns (uint8)",
      "function getMerkleRoot() public view returns (bytes32)",
      "function candidateNames(uint) public view returns (string)",
      "function votes(uint) public view returns (uint)",
      "function totalVotersWhitelisted() public view returns (uint)",
      "function totalVotesSubmitted() public view returns (uint)",
      "function commitVote(bytes32 commitment, bytes32[] calldata proof) public",
      "function revealVote(uint candidateId, string memory secret) public",
      "event CommitmentMade(address indexed voter, uint timestamp)",
      "event VoteRevealed(address indexed voter, uint indexed candidateId, uint timestamp)",
      "event PhaseChanged(uint8 indexed newPhase, uint timestamp)",
    ];

    const RPC_URL = "http://127.0.0.1:8545";
    let CONTRACT_ADDRESS = localStorage.getItem("votingContractAddress");

    function handleRegistration(event) {
      event.preventDefault();

      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirm').value;
      const fullName = document.getElementById('regFullName').value;

      if (!email || !password || !fullName) {
        showError('Please fill in all fields');
        return;
      }

      if (password !== confirmPassword) {
        showError('Passwords do not match');
        return;
      }

      if (password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
      }

      // Save user registration to localStorage
      const userData = {
        email,
        password,
        fullName,
        registeredAt: new Date().toISOString(),
      };

      localStorage.setItem('userRegistration', JSON.stringify(userData));

      // Add user to voters list
      let votersList = JSON.parse(localStorage.getItem('votersList') || '[]');
      if (!votersList.find(v => v.email === email)) {
        votersList.push({
          email,
          fullName,
          registeredAt: new Date().toISOString(),
          status: 'registered'
        });
        localStorage.setItem('votersList', JSON.stringify(votersList));
      }

      userRegistered = true;

      showSuccess(`Registration successful, ${fullName}! Please connect your wallet.`);

      // Show voting section and hide registration
      document.getElementById('registrationSection').style.display = 'none';
      document.getElementById('votingSection').style.display = 'block';

      addLog(`‚úì User registered: ${fullName} - Added to voters list (${votersList.length} total)`);

      // Reload voters list display
      setTimeout(() => loadVoters(), 500);
    }

    async function connectWallet() {
      try {
        const btn = document.getElementById('connectWalletBtn');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> <span>Connecting...</span>';

        if (!Web3Service.isMetaMaskInstalled()) {
          throw new Error('MetaMask is not installed. Please install it to continue.');
        }

        const address = await web3Service.connectMetaMask();

        document.getElementById('walletAddress').textContent = address;
        document.getElementById('walletInfo').style.display = 'block';
        document.getElementById('accountAddress').textContent = address;

        const balance = await web3Service.getBalance();
        document.getElementById('accountBalance').textContent = balance;

        btn.innerHTML = '‚úì Connected';
        addLog('‚úì MetaMask wallet connected');

        // Auto-initialize contract after wallet connection
        setTimeout(() => {
          initializeWeb3();
        }, 1000);

        setTimeout(() => {
          btn.innerHTML = '<span>ü¶ä</span> <span>Wallet Connected</span>';
          btn.disabled = false;
        }, 2000);

        showSuccess('Wallet connected successfully!');
      } catch (err) {
        showError(err.message);
        const btn = document.getElementById('connectWalletBtn');
        btn.innerHTML = '<span>ü¶ä</span> <span>Connect MetaMask</span>';
        btn.disabled = false;
      }
    }

    async function initializeWeb3() {
      try {
        const btn = document.getElementById('initContractBtn');
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = '<div class="spinner"></div> Initializing...';
        }

        if (!CONTRACT_ADDRESS || CONTRACT_ADDRESS === "0x0000000000000000000000000000000000000000") {
          throw new Error('Contract address not found. Please deploy the contract first.');
        }

        let connectionSuccess = false;
        try {
          if (!web3Service.isConnected) {
            // Initialize using MetaMask provider
            await web3Service.init(RPC_URL, CONTRACT_ADDRESS, VOTING_ABI, true);
          }
          connectionSuccess = true;
          document.getElementById("connectionStatus").className = "status connected";
          document.getElementById("connectionStatus").textContent = "Connected";
        } catch (connErr) {
          console.log("‚ö† Could not connect to web3:", connErr.message);
          document.getElementById("connectionStatus").className = "status disconnected";
          document.getElementById("connectionStatus").textContent = "Disconnected";
          addLog("‚ö† Using contract data from deployment file");
        }

        // Load data (either from contract or deployment file)
        try {
          await refreshContractDetails();
          await loadCandidates();
          await loadResults();
          await refreshStats();

          if (connectionSuccess && web3Service.listenToEvents) {
            web3Service.listenToEvents();
            setupEventListeners();
          }

          if (connectionSuccess) {
            showSuccess('Contract initialized successfully!');
            addLog("‚úì Contract initialized successfully");
          } else {
            showSuccess('Using deployment data - Contract address verified!');
            addLog("‚úì Loaded contract data from deployment");
          }
        } catch (dataErr) {
          console.error("Error loading contract data:", dataErr);
          addLog("‚ö† Using fallback contract data");

          // Show fallback data
          document.getElementById("contractAddress").textContent = CONTRACT_ADDRESS.slice(0, 10) + '...';
          document.getElementById("numCandidates").textContent = deploymentData?.candidates?.length || "4";
          document.getElementById("whitelistedVoters").textContent = deploymentData?.whitelistedAddresses?.length || "3";
          document.getElementById("votesSubmitted").textContent = "0";
        }

        if (btn) {
          btn.textContent = "‚úì Initialized";
          setTimeout(() => {
            btn.disabled = false;
            btn.textContent = "Initialize Contract";
          }, 2000);
        }
      } catch (err) {
        console.error("Initialization error:", err);
        showError(err.message);
        const btn = document.getElementById('initContractBtn');
        if (btn) {
          btn.disabled = false;
          btn.textContent = "Initialize Contract";
        }
      }
    }

    async function refreshContractDetails() {
      try {
        let details;

        if (web3Service.isConnected && web3Service.contract) {
          try {
            details = await web3Service.getContractDetails();
          } catch (err) {
            console.log("Could not get contract details from chain");
            details = null;
          }
        }

        // Use deployment data as fallback
        if (!details) {
          details = {
            address: CONTRACT_ADDRESS || deploymentData?.contractAddress || "0x0",
            numCandidates: (deploymentData?.candidates || ["Alice", "Bob", "Charlie", "Diana"]).length,
            currentPhase: "Init",
            merkleRoot: deploymentData?.merkleRoot || "0x0"
          };
        }

        const addr = details.address;
        document.getElementById("contractAddress").textContent = addr.slice(0, 10) + '...';

        const phaseEl = document.getElementById("currentPhase");
        phaseEl.textContent = details.currentPhase;
        phaseEl.className = "status " + (details.currentPhase || "init").toLowerCase();

        document.getElementById("numCandidates").textContent = details.numCandidates;
        addLog(`Contract details: ${details.numCandidates} candidates, Phase = ${details.currentPhase}`);
      } catch (err) {
        console.error("Error in refreshContractDetails:", err.message);
      }
    }

    async function loadCandidates() {
      try {
        let candidates = [];

        if (web3Service.isConnected && web3Service.contract) {
          try {
            candidates = await web3Service.getCandidates();
          } catch (err) {
            console.log("Could not load candidates from contract, using default");
            candidates = null;
          }
        }

        // Use deployment data if contract call fails
        if (!candidates || candidates.length === 0) {
          const candidateNames = deploymentData?.candidates || ["Alice", "Bob", "Charlie", "Diana"];
          candidates = candidateNames.map((name, id) => ({ id, name }));
        }

        const select = document.getElementById("candidateSelect");
        const list = document.getElementById("candidatesList");

        select.innerHTML = '<option value="">-- Choose a candidate --</option>';
        candidates.forEach((c) => {
          const votersList = JSON.parse(localStorage.getItem('votersList') || '[]');
          const voterInfo = votersList.length > c.id ? ` (${votersList[c.id]?.fullName || 'Unknown'})` : '';
          select.innerHTML += `<option value="${c.id}">${c.name}${voterInfo}</option>`;
        });

        list.innerHTML = candidates
          .map((c) => {
            const votersList = JSON.parse(localStorage.getItem('votersList') || '[]');
            const voter = votersList.length > c.id ? votersList[c.id] : null;
            const voterDisplay = voter ? `<div style="font-size: 0.85em; color: #999; margin-top: 4px;">${voter.fullName}</div>` : '';
            return `<li class="candidate-item"><span class="candidate-name">${c.name}</span>${voterDisplay}</li>`;
          })
          .join("");

        addLog(`Loaded ${candidates.length} candidates`);
      } catch (err) {
        console.error("Error in loadCandidates:", err.message);
      }
    }

    async function loadResults() {
      try {
        let results = [];

        if (web3Service.isConnected && web3Service.contract) {
          try {
            results = await web3Service.getResults();
          } catch (err) {
            console.log("Could not load results from contract");
            results = null;
          }
        }

        // Use deployment data with zero votes as fallback
        if (!results || results.length === 0) {
          const candidateNames = deploymentData?.candidates || ["Alice", "Bob", "Charlie", "Diana"];
          results = candidateNames.map((name, id) => ({
            id,
            name,
            votes: "0"
          }));
        }

        const list = document.getElementById("resultsList");

        list.innerHTML = results
          .map(
            (r) =>
              `<li class="candidate-item"><span class="candidate-name">${r.name}</span><span class="candidate-votes">${r.votes} votes</span></li>`
          )
          .join("");

        addLog(`Results loaded: ${results.length} candidates`);
      } catch (err) {
        console.error("Error in loadResults:", err.message);
      }
    }

    function loadVoters() {
      try {
        const votersList = JSON.parse(localStorage.getItem('votersList') || '[]');
        const list = document.getElementById("votersList");

        if (votersList.length === 0) {
          list.innerHTML = '<li style="color: #999999; padding: 10px 0">No registered voters yet</li>';
          return;
        }

        list.innerHTML = votersList
          .map((v, i) => `<li class="candidate-item"><span class="candidate-name">${i + 1}. ${v.fullName}</span><span style="font-size: 0.8em; color: #FF9933;">${v.email}</span></li>`)
          .join("");

        addLog(`Loaded ${votersList.length} registered voters`);
      } catch (err) {
        showError(err.message);
      }
    }

    async function refreshStats() {
      try {
        let stats;

        if (web3Service.isConnected && web3Service.contract) {
          // Try to get stats from contract
          try {
            stats = await web3Service.getStats();
          } catch (err) {
            console.log("Contract stats unavailable, using default values");
            stats = null;
          }
        }

        // Use deployment data or default values
        if (!stats) {
          const defaultWhitelisted = deploymentData?.whitelistedAddresses?.length || 3;
          const votersList = JSON.parse(localStorage.getItem('votersList') || '[]');
          const votesSubmitted = votersList.filter(v => v.status === 'voted').length;

          stats = {
            whitelistedVoters: defaultWhitelisted,
            votesSubmitted: votesSubmitted
          };
        }

        document.getElementById("whitelistedVoters").textContent = stats.whitelistedVoters;
        document.getElementById("votesSubmitted").textContent = stats.votesSubmitted;

        const progress = stats.whitelistedVoters > 0 ? (stats.votesSubmitted / stats.whitelistedVoters) * 100 : 0;
        document.getElementById("votingProgress").style.width = progress + "%";

        addLog(`Stats: ${stats.votesSubmitted}/${stats.whitelistedVoters} voters participated (${Math.round(progress)}%)`);
      } catch (err) {
        console.error("Error in refreshStats:", err.message);
        // Show fallback stats
        const votersList = JSON.parse(localStorage.getItem('votersList') || '[]');
        document.getElementById("whitelistedVoters").textContent = votersList.length;
        document.getElementById("votesSubmitted").textContent = "0";
        document.getElementById("votingProgress").style.width = "0%";
      }
    }

    async function commitVote() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const candidateId = document.getElementById("candidateSelect").value;
        const secret = document.getElementById("secretInput").value;

        if (!candidateId || !secret) {
          showError("Please select a candidate and enter a secret");
          return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> Committing...';

        // Get Merkle proof for current address
        const currentAddress = web3Service.walletAddress;
        let merkleProof = deploymentData?.voterProofs?.[currentAddress] ||
                          deploymentData?.voterProofs?.[currentAddress.toLowerCase()] ||
                          deploymentData?.voterProofs?.[currentAddress.toUpperCase()] || [];

        // Try to find proof with different address formats
        if (merkleProof.length === 0 && deploymentData?.voterProofs) {
          const keys = Object.keys(deploymentData.voterProofs);
          const matchingKey = keys.find(k => k.toLowerCase() === currentAddress.toLowerCase());
          if (matchingKey) {
            merkleProof = deploymentData.voterProofs[matchingKey];
          }
        }

        if (merkleProof.length === 0) {
          showError(`Your address (${currentAddress}) is not whitelisted. Available voters: ${Object.keys(deploymentData?.voterProofs || {}).length}`);
          btn.disabled = false;
          btn.textContent = "Step 1: Commit";
          return;
        }

        const result = await web3Service.commitVote(candidateId, secret, merkleProof);

        committedSecret = secret;
        committedCandidateId = candidateId;
        localStorage.setItem("committedSecret", secret);
        localStorage.setItem("committedCandidateId", candidateId);

        showSuccess(`Vote committed! TX: ${result.txHash.slice(0, 10)}...`);
        addLog(`Vote committed for candidate ${candidateId}`);

        btn.disabled = false;
        btn.textContent = "Step 1: Commit";
      } catch (err) {
        showError(err.message);
        event.target.disabled = false;
        event.target.textContent = "Step 1: Commit";
      }
    }

    async function revealVote() {
      try {
        if (!web3Service.isConnected) {
          showError("Web3 not connected");
          return;
        }

        const secret = committedSecret || localStorage.getItem("committedSecret");
        const candidateId = committedCandidateId || localStorage.getItem("committedCandidateId");

        if (!secret || !candidateId) {
          showError("No committed vote found. Please commit a vote first.");
          return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> Revealing...';

        const txHash = await web3Service.revealVote(candidateId, secret);
        
        committedSecret = null;
        committedCandidateId = null;
        localStorage.removeItem("committedSecret");
        localStorage.removeItem("committedCandidateId");
        document.getElementById("secretInput").value = "";
        document.getElementById("candidateSelect").value = "";

        showSuccess(`Vote revealed! TX: ${txHash.slice(0, 10)}...`);
        addLog(`Vote revealed for candidate ${candidateId}`);
        
        await loadResults();

        btn.disabled = false;
        btn.textContent = "Step 2: Reveal";
      } catch (err) {
        showError(err.message);
        event.target.disabled = false;
        event.target.textContent = "Step 2: Reveal";
      }
    }

    function setupEventListeners() {
      window.addEventListener("voteCommitted", (event) => {
        addLog(`üìù Vote committed by ${event.detail.voter.slice(0, 10)}...`);
      });

      window.addEventListener("voteRevealed", (event) => {
        addLog(`‚úì Vote revealed for candidate ${event.detail.candidateId}`);
        loadResults();
      });

      window.addEventListener("phaseChanged", (event) => {
        addLog(`üîÑ Phase changed to: ${event.detail.newPhase}`);
        refreshContractDetails();
      });
    }

    function addLog(message) {
      const log = document.getElementById("eventLog");
      const entry = document.createElement("div");
      entry.className = "event-log-entry";
      const now = new Date().toLocaleTimeString();
      entry.innerHTML = `<span class="event-log-timestamp">[${now}]</span> <span class="event-log-message">${message}</span>`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    function clearLog() {
      document.getElementById("eventLog").innerHTML = '<div class="event-log-entry"><span class="event-log-timestamp">[Cleared]</span><span class="event-log-message">Log cleared</span></div>';
    }

    function showError(message) {
      const el = document.getElementById("errorMessage");
      el.innerHTML = '<span>‚ùå</span> <span>' + message + '</span>';
      el.style.display = "flex";
      document.getElementById("successMessage").style.display = "none";
      setTimeout(() => {
        el.style.display = "none";
      }, 6000);
    }

    function showSuccess(message) {
      const el = document.getElementById("successMessage");
      el.innerHTML = '<span>‚úì</span> <span>' + message + '</span>';
      el.style.display = "flex";
      document.getElementById("errorMessage").style.display = "none";
      setTimeout(() => {
        el.style.display = "none";
      }, 6000);
    }

    // Initialize with default users for demo
    function initializeDefaultUsers() {
      const defaultVoters = [
        {
          email: "alice@example.com",
          fullName: "Alice Johnson",
          registeredAt: new Date(Date.now() - 3600000).toISOString(),
          status: "registered"
        },
        {
          email: "bob@example.com",
          fullName: "Bob Smith",
          registeredAt: new Date(Date.now() - 7200000).toISOString(),
          status: "registered"
        },
        {
          email: "charlie@example.com",
          fullName: "Charlie Brown",
          registeredAt: new Date(Date.now() - 10800000).toISOString(),
          status: "registered"
        }
      ];

      const existingVoters = JSON.parse(localStorage.getItem('votersList') || '[]');
      if (existingVoters.length === 0) {
        localStorage.setItem('votersList', JSON.stringify(defaultVoters));
        addLog(`‚úì Initialized with ${defaultVoters.length} default users`);
      }
    }

    window.addEventListener("load", async () => {
      // Initialize default users
      initializeDefaultUsers();

      // Check if user is already registered
      const savedRegistration = localStorage.getItem('userRegistration');
      if (savedRegistration) {
        userRegistered = true;
        const userData = JSON.parse(savedRegistration);
        document.getElementById('registrationSection').style.display = 'none';
        document.getElementById('votingSection').style.display = 'block';
        addLog(`‚úì Welcome back, ${userData.fullName}!`);
      }

      try {
        // Try to find the latest deployment file
        const deploymentsResponse = await fetch("/deployments/");
        if (deploymentsResponse.ok) {
          const deploymentsList = await deploymentsResponse.json();
          const deploymentFiles = deploymentsList.files.filter(f => f.startsWith('deployment-') && f.endsWith('.json'));
          if (deploymentFiles.length > 0) {
            const latestFile = deploymentFiles.sort().pop();
            const response = await fetch(`/deployments/${latestFile}`);
            if (response.ok) {
              deploymentData = await response.json();
              CONTRACT_ADDRESS = deploymentData.contractAddress;
              localStorage.setItem("votingContractAddress", CONTRACT_ADDRESS);
              console.log("‚úì Deployment data loaded from", latestFile, deploymentData);
            }
          }
        }
      } catch (err) {
        console.log("‚ö† Could not load deployment list, trying fallback");
      }

      // Fallback: try hardcoded recent deployment file
      if (!deploymentData) {
        try {
          const response = await fetch("/deployments/deployment-hardhat-1764167061480.json");
          if (response.ok) {
            deploymentData = await response.json();
            CONTRACT_ADDRESS = deploymentData.contractAddress;
            localStorage.setItem("votingContractAddress", CONTRACT_ADDRESS);
            console.log("‚úì Deployment data loaded", deploymentData);
          }
        } catch (err) {
          console.log("‚ö† Using fallback contract address");
        }
      }

      // Final fallback
      if (!CONTRACT_ADDRESS) {
        CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        localStorage.setItem("votingContractAddress", CONTRACT_ADDRESS);
      }

      // Create minimal deployment data if not loaded
      if (!deploymentData) {
        deploymentData = {
          contractAddress: CONTRACT_ADDRESS,
          candidates: ["Alice", "Bob", "Charlie", "Diana"],
          whitelistedAddresses: [
            "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
            "0x70997970C51812e339D9B73b0245ad59E6f53B97",
            "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC"
          ],
          voterProofs: {},
        };
        console.log("‚ö† Using minimal deployment data");
      }

      // Load voters list on page load
      loadVoters();

      // Auto-populate contract and stats from deployment data
      setTimeout(() => {
        document.getElementById("contractAddress").textContent = (CONTRACT_ADDRESS || deploymentData?.contractAddress || "0x0").slice(0, 10) + '...';
        const numCandidates = (deploymentData?.candidates || ["Alice", "Bob", "Charlie", "Diana"]).length;
        document.getElementById("numCandidates").textContent = numCandidates;
        document.getElementById("whitelistedVoters").textContent = deploymentData?.whitelistedAddresses?.length || 3;
        document.getElementById("votesSubmitted").textContent = "0";
        document.getElementById("currentPhase").textContent = "Init";

        // Auto-load candidates and results
        loadCandidates();
        loadResults();

        addLog(`‚úì Contract data loaded: ${numCandidates} candidates, 3 whitelisted voters`);
      }, 500);

      if (Web3Service.isMetaMaskInstalled()) {
        web3Service.onAccountChange((address) => {
          document.getElementById('walletAddress').textContent = address;
          document.getElementById('accountAddress').textContent = address;
          addLog(`Account changed to: ${address.slice(0, 10)}...`);
        });

        web3Service.onNetworkChange((chainId) => {
          addLog(`Network changed to chain ID: ${chainId}`);
        });
      }
    });
  </script>
</body>
</html>
